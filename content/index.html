<html>
   <head>
      <title>Cafre Client</title>
      <style>
         #viewport { background-color: black; position: relative; overflow: hidden; width: 512px; height: 512px; }
         #viewport canvas { position: absolute; }
      </style>
   </head>
   <body>
      <script src="/script.js"></script>
      <script>
window.onload = function() {
   var body = document.getElementsByTagName('body')[0];
   var viewport = document.createElement("div");
   viewport.setAttribute("id", "viewport");
   body.appendChild(viewport);
   var c = document.createElement("canvas");
   c.setAttribute("id", "main");
   c.setAttribute("width", "512");
   c.setAttribute("height", "512");
   viewport.appendChild(c);
   var l = document.createElement("span");
   l.setAttribute("id", "l");
   body.appendChild(l);
   //var c = document.getElementById("main");
   var ctx = c.getContext("2d");
   canvases["main"] = { c: c, ctx: ctx };
   ctx.fillStyle = "#FFFFFF";
   ctx.fillText("Press SPACE to connect.", 16, 16);
   
   
   async function process(r) {
      if (Array.isArray(r)) {
         for (var i = 0; i < r.length; ++i) {
            var inst = r[i];
            if (Array.isArray(inst)) {
               var name = inst[0];
               var args = inst[1];
               await window.fns[name].apply(this, args);
            } else {
               throw "Unhandled instruction";
            }
         }
      } else {
         throw "Unhandled instruction";
      }
   }

   var cTime;
   var xhr;
   var l = document.getElementById("l");
   var start;
   var startListener = function(e) {
      if (e.keyCode == 32) {
         document.removeEventListener("keydown", startListener);
         start();
      }
      e.preventDefault();
   };
   
   document.addEventListener("keydown", startListener);
   
   start = function() {
      ctx.clearRect(0, 0, 512, 512);
      var events = [["load"]];
      document.addEventListener('keydown', function(e) {
         //console.log(e.keyCode);
         events.push(["keydown", e.keyCode]);
         e.preventDefault();
      });
      document.addEventListener('keyup', function(e) {
         //console.log(e.keyCode);
         events.push(["keyup", e.keyCode]);
         e.preventDefault();
      });

      var connection = new WebSocket(server);
      var frame;

      connection.onmessage = async function (message) {
         var r = message.data;
         await process(JSON.parse(r));
         var nTime = new Date().getTime();
         var dTime = nTime - cTime;
         var w = 1000 / 60;
         w -= dTime;
         if (w < 0) {
            console.warn("Slow frame!!!");
            //l.innerHTML = "!!!";
            w = 0;
         } else {
            //l.innerHTML = "";
         }
         cTime = nTime;
         setTimeout(frame, w);
      };

      frame = function() {
         var ev = JSON.stringify(events);
         connection.send(ev);
         events = [];
      }

      function waitForSocketConnection(socket, callback){
       setTimeout(
           function () {
               if (socket.readyState === 1) {
                   console.log("Connection is made")
                   if(callback != null){
                       cTime = new Date().getTime();
                       callback();
                   }
                   return;

               } else {
                   console.log("wait for connection...")
                   waitForSocketConnection(socket, callback);
               }

           }, 5);
      }
      waitForSocketConnection(connection, frame);
   };
};
      </script>
   </body>
</html>
